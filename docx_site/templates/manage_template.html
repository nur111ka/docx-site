{% extends "base.html" %}

{% block content %}
<h1>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∞–±–ª–æ–Ω–∞: <code>{{ template_name }}</code></h1>

<div class="tabs">
    <button class="tab active" data-tab="fields-tab">üìù –ü–æ–ª—è —Ñ–æ—Ä–º—ã</button>
    <button class="tab" data-tab="json-tab">üîÑ JSON –∑–∞–º–µ–Ω—ã</button>
    <button class="tab" data-tab="file-tab">üìÅ –§–∞–π–ª —à–∞–±–ª–æ–Ω–∞</button>
    <button class="tab" data-tab="keys-tab">üîë API –ö–ª—é—á–∏</button>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞ –ø–æ–ª–µ–π -->
<div id="fields-tab" class="tab-content active">
    <div class="card">
        <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</h3>
        <form method="POST">
            <input type="hidden" name="action" value="add_field">
            
            <div class="form-group">
                <label>–ò–º—è –ø–æ–ª—è (–∞–Ω–≥–ª):</label>
                <input type="text" name="field_name" placeholder="client_address" required>
            </div>
            
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ (—Ä—É—Å):</label>
                <input type="text" name="field_label" placeholder="–ê–¥—Ä–µ—Å –∫–ª–∏–µ–Ω—Ç–∞" required>
            </div>
            
            <div class="form-group">
                <label>–¢–∏–ø:</label>
                <select name="field_type">
                    <option value="text">–¢–µ–∫—Å—Ç</option>
                    <option value="textarea">–ú–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞</option>
                    <option value="date">–î–∞—Ç–∞</option>
                    <option value="number">–ß–∏—Å–ª–æ</option>
                    <option value="email">Email</option>
                    <option value="tel">–¢–µ–ª–µ—Ñ–æ–Ω</option>
                </select>
            </div>
            
            <button type="submit" class="btn">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ</button>
        </form>
    </div>
    
    <div class="card">
        <h3>üìã –ü–æ–ª—è —à–∞–±–ª–æ–Ω–∞</h3>
        
        {% if fields %}
        <table class="table">
            <thead>
                <tr>
                    <th>–ò–º—è –ø–æ–ª—è</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–¢–∏–ø</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for field_name, field_label, field_type, field_order in fields %}
                <tr>
                    <td><code>[{{ field_name }}]</code></td>
                    <td>{{ field_label }}</td>
                    <td>{{ field_type }}</td>
                    <td>
                        <button onclick="editField('{{ field_name }}', '{{ field_label }}', '{{ field_type }}')" 
                                class="btn btn-secondary">
                            ‚úèÔ∏è
                        </button>
                        
                        <form method="POST" style="display: inline;">
                            <input type="hidden" name="action" value="delete_field">
                            <input type="hidden" name="field_name" value="{{ field_name }}">
                            <button type="submit" class="btn btn-danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª–µ?')">
                                üóëÔ∏è
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>–ù–µ—Ç –ø–æ–ª–µ–π. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ –ø–æ–ª–µ –≤—ã—à–µ.</p>
        {% endif %}
    </div>
    
    <!-- –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="edit-form" style="display: none; margin-top: 20px;" class="card">
        <h3>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–µ</h3>
        <form method="POST">
            <input type="hidden" name="action" value="update_field">
            <input type="hidden" id="edit_field_name" name="field_name">
            
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–ª—è:</label>
                <input type="text" id="edit_field_label" name="field_label" required>
            </div>
            
            <div class="form-group">
                <label>–¢–∏–ø:</label>
                <select id="edit_field_type" name="field_type">
                    <option value="text">–¢–µ–∫—Å—Ç</option>
                    <option value="textarea">–ú–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞</option>
                    <option value="date">–î–∞—Ç–∞</option>
                    <option value="number">–ß–∏—Å–ª–æ</option>
                </select>
            </div>
            
            <button type="submit" class="btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button type="button" onclick="hideEditForm()" class="btn btn-secondary">‚ùå –û—Ç–º–µ–Ω–∞</button>
        </form>
    </div>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞ JSON -->
<div id="json-tab" class="tab-content">
    <div class="card">
        <h3>üîÑ JSON –∑–∞–º–µ–Ω –¥–ª—è —à–∞–±–ª–æ–Ω–∞</h3>
        <p>–ó–¥–µ—Å—å –∑–∞–¥–∞–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–º–µ–Ω—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä:</p>
        <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px;">
{
    "[COMPANY_NAME]": "–û–û–û –†–æ–º–∞—à–∫–∞",
    "[COMPANY_ADDRESS]": "–≥. –ú–æ—Å–∫–≤–∞",
    "[TODAY_DATE]": "2024-01-01"
}</pre>
        
        <div class="form-group">
            <label>JSON –∑–∞–º–µ–Ω:</label>
            <textarea id="replacements_json" rows="15" style="font-family: monospace;">{{ replacements_json }}</textarea>
        </div>
        
        <button onclick="saveReplacements()" class="btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å JSON</button>
        <div id="json-message" style="margin-top: 10px;"></div>
    </div>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞ —Ñ–∞–π–ª–∞ -->
<div id="file-tab" class="tab-content">
    <div class="card">
        <h3>üìÅ –§–∞–π–ª —à–∞–±–ª–æ–Ω–∞ DOCX</h3>
        
        {% if template_file_exists %}
        <div class="alert alert-success">
            ‚úÖ –§–∞–π–ª —à–∞–±–ª–æ–Ω–∞ –∑–∞–≥—Ä—É–∂–µ–Ω: <code>{{ template_name }}.docx</code>
        </div>
        {% else %}
        <div class="alert alert-error">
            ‚ùå –§–∞–π–ª —à–∞–±–ª–æ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–≥—Ä—É–∑–∏—Ç–µ DOCX —Ñ–∞–π–ª.
        </div>
        {% endif %}
        
        <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="action" value="upload_template_file">
            
            <div class="form-group">
                <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª —à–∞–±–ª–æ–Ω–∞ (.docx):</label>
                <input type="file" name="template_file" accept=".docx">
            </div>
            
            <button type="submit" class="btn">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </form>
        
        <div style="margin-top: 20px; background: #f0f9ff; padding: 15px; border-radius: 5px;">
            <h4>üí° –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª—è –≤ DOCX —Ñ–∞–π–ª–µ:</h4>
            <p>–í —Ñ–∞–π–ª–µ —à–∞–±–ª–æ–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–º–µ–Ω–∞ –ø–æ–ª–µ–π –≤ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö:</p>
            <ul>
                <li>–î–ª—è –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã: <code>[field_name]</code></li>
                <li>–î–ª—è JSON –∑–∞–º–µ–Ω: <code>[COMPANY_NAME]</code></li>
            </ul>
            <p><strong>–ü—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –≤ DOCX:</strong><br>
            <code>–î–æ–≥–æ–≤–æ—Ä –º–µ–∂–¥—É [COMPANY_NAME] –∏ [client_name] –Ω–∞ —Å—É–º–º—É [amount].</code></p>
        </div>
    </div>
</div>

<!-- –í–∫–ª–∞–¥–∫–∞ –∫–ª—é—á–µ–π -->
<div id="keys-tab" class="tab-content">
    <div class="card">
        <h3>üîë –°–æ–∑–¥–∞—Ç—å API –∫–ª—é—á –¥–ª—è —ç—Ç–æ–≥–æ —à–∞–±–ª–æ–Ω–∞</h3>
        <form method="POST" action="{{ url_for('admin') }}">
            <input type="hidden" name="action" value="create_key">
            <input type="hidden" name="key_client_name" value="{{ template_name }}">
            
            <div class="form-group">
                <label>–õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π:</label>
                <input type="number" name="limit_count" value="10" min="1" max="1000">
            </div>
            
            <button type="submit" class="btn">–°–æ–∑–¥–∞—Ç—å –∫–ª—é—á</button>
        </form>
    </div>
</div>

<script>
// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
        const tabId = this.dataset.tab;
        
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        this.classList.add('active');
        document.getElementById(tabId).classList.add('active');
    });
});

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–µ–π
function editField(fieldName, fieldLabel, fieldType) {
    document.getElementById('edit_field_name').value = fieldName;
    document.getElementById('edit_field_label').value = fieldLabel;
    document.getElementById('edit_field_type').value = fieldType;
    
    document.getElementById('edit-form').style.display = 'block';
    document.getElementById('edit-form').scrollIntoView({ behavior: 'smooth' });
}

function hideEditForm() {
    document.getElementById('edit-form').style.display = 'none';
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ JSON
async function saveReplacements() {
    const jsonText = document.getElementById('replacements_json').value;
    const messageDiv = document.getElementById('json-message');
    
    try {
        const response = await fetch('{{ url_for("manage_template", template_name=template_name) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `action=save_replacements&replacements_json=${encodeURIComponent(jsonText)}`
        });
        
        const result = await response.json();
        
        if (result.success) {
            messageDiv.innerHTML = '<div class="alert alert-success">‚úÖ JSON —Å–æ—Ö—Ä–∞–Ω–µ–Ω!</div>';
        } else {
            messageDiv.innerHTML = `<div class="alert alert-error">‚ùå ${result.message}</div>`;
        }
    } catch (error) {
        messageDiv.innerHTML = `<div class="alert alert-error">‚ùå –û—à–∏–±–∫–∞: ${error}</div>`;
    }
    
    setTimeout(() => {
        messageDiv.innerHTML = '';
    }, 3000);
}
</script>
{% endblock %}